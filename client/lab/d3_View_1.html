<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <div id="view"></div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.3.0/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.25.0/axios.min.js"></script>
<script>

    const data =
        {
            'Q_0': [
                {
                    'timestamp': 1000,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 110
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 135
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1100,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 100
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 137
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1200,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 127
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 132
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 160
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 123
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 145
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1300,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 110
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 135
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1400,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 100
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 137
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                }
            ],
            'Q_1': [
                {
                    'timestamp': 1000,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 110
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 135
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1100,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 100
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 137
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1200,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 127
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 132
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 160
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 123
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 145
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1300,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 110
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 135
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [

                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.014
                        },
                        {
                            'source': 'q_2',
                            'target': 'q_4',
                            'error_rate': 0.093
                        }
                    ]
                },
                {
                    'timestamp': 1400,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 100
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 137
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [

                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.044
                        },
                        {
                            'source': 'q_2',
                            'target': 'q_4',
                            'error_rate': 0.073
                        }
                    ]
                },
                {
                    'timestamp': 1500,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 127
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 132
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 160
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 123
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 145
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        },
                        {
                            'source': 'q_2',
                            'target': 'q_4',
                            'error_rate': 0.13
                        }
                    ]
                },
            ],
            'Q_2': [
                {
                    'timestamp': 1000,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 110
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 135
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1100,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 100
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 137
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1200,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 127
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 132
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 160
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 123
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 145
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1300,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 110
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 135
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [

                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.014
                        },
                        {
                            'source': 'q_2',
                            'target': 'q_4',
                            'error_rate': 0.093
                        }
                    ]
                },
                {
                    'timestamp': 1400,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 100
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 137
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [

                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.044
                        },
                        {
                            'source': 'q_2',
                            'target': 'q_4',
                            'error_rate': 0.073
                        }
                    ]
                },
                {
                    'timestamp': 1500,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 127
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 132
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 160
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 123
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 145
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        },
                        {
                            'source': 'q_2',
                            'target': 'q_4',
                            'error_rate': 0.13
                        }
                    ]
                },
            ],
            'Q_3': [
                {
                    'timestamp': 1000,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 110
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 135
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1100,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 100
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 137
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1200,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 127
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 132
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 160
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 123
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 145
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        }
                    ]
                },
                {
                    'timestamp': 1300,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 110
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 135
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [

                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.014
                        },
                        {
                            'source': 'q_2',
                            'target': 'q_4',
                            'error_rate': 0.093
                        }
                    ]
                },
                {
                    'timestamp': 1400,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 164
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 100
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 137
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 125
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 120
                        },
                    ],
                    'gate': [

                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.044
                        },
                        {
                            'source': 'q_2',
                            'target': 'q_4',
                            'error_rate': 0.073
                        }
                    ]
                },
                {
                    'timestamp': 1500,
                    'qubit': [
                        {
                            'qubit_id': 'q_0',
                            'T1': 127
                        },
                        {
                            'qubit_id': 'q_1',
                            'T1': 132
                        },
                        {
                            'qubit_id': 'q_2',
                            'T1': 160
                        },
                        {
                            'qubit_id': 'q_3',
                            'T1': 123
                        },
                        {
                            'qubit_id': 'q_4',
                            'T1': 145
                        },
                    ],
                    'gate': [
                        {
                            'source': 'q_0',
                            'target': 'q_1',
                            'error_rate': 0.024
                        },
                        {
                            'source': 'q_2',
                            'target': 'q_4',
                            'error_rate': 0.13
                        }
                    ]
                },
            ],

        }

    const ref_value = 130

    const attr = 'T1'

    /*size for View 1*/
    const view1_computer_height = 160
    const view1_computer_width= 500
    const view1_computer_block_width = 80
    const view1_computer_block_height = 100
    const view1_qubitMaxRadius = 9
    const view1_qubitHeight = 100

    const view1_padding_top = 20, view1_padding_bottom = 40, view1_padding_left = 40, view1_padding_right = 10
    const view1_block_top = 40, view1_qubit_padding_left = 10

    const theta = 1



    /*qubit的位置字典*/
    const qubit_position_dict= {
        'q_0': view1_block_top + 0*2*view1_qubitMaxRadius*theta,
        'q_1': view1_block_top + 1*2*view1_qubitMaxRadius*theta,
        'q_2': view1_block_top + 2*2*view1_qubitMaxRadius*theta,
        'q_3': view1_block_top + 3*2*view1_qubitMaxRadius*theta,
        'q_4': view1_block_top + 4*2*view1_qubitMaxRadius*theta
    }


    let svg = d3.select('#view')
        .append('svg')
        .attr('width', 600)
        .attr('height', 600)


    let view1 = svg.append('g')
        .attr('class', 'view1')
        .attr('transform', `translate(0,0)`)


    /*!* 先画qubit对齐线, 因为在最下面 */
    let time_arr = Object.values(data).map(d=>{return d.map(_d=>{return _d['timestamp']})})

    let computer_qubit_ref_line_data = Object.values(data).map(d=>{return d[0]['qubit'].length}).map(d=>{return d3.range(d)})

    let ref_line = view1.selectAll('g')
        .data(computer_qubit_ref_line_data)
        .join('g')
        .attr('class', 'ref_line')
        .attr('transform', (d,i)=>`translate(0,${i*view1_computer_height*theta})`)

    ref_line.selectAll('line')
        .data(d=>d)
        .join('line')
        .style('stroke', '#a3e1e8')
        .style('stroke-width', 1)
        .attr('class', 'circuit_ref_line')
        .attr('x1', view1_padding_left)
        .attr('x2', view1_padding_left + view1_computer_width)
        .attr('y1', d=>view1_padding_top + view1_block_top + d*2*view1_qubitMaxRadius*theta)
        .attr('y2', d=>view1_padding_top + view1_block_top + d*2*view1_qubitMaxRadius*theta)



    /*开始画除了ref_line 之外的元素*/
    let qcomputer = view1.selectAll('.qcomputer')
        .data(Object.values(data))
        .join('g')
        .attr('class', `qcomputer`)
        .attr('transform', (d,i)=>`translate(0,${i*view1_computer_height*theta})`)


    /*每个糖葫芦+电路线段组成的基本单位叫做一个 block*/
    let block = qcomputer.selectAll('g')
    .data(d=>d)
    .join('g')
    .attr('transform', (_d,_i)=>`translate(${view1_padding_left + _i*view1_computer_block_width*theta},${view1_padding_top*theta})`)


    /*画 block 中的串糖葫芦的棍*/
    block.append('line')
        .style('stroke', '#d9d9d9')
        .style('stroke-width', 2)
        .attr('x1', view1_qubit_padding_left*theta)
        .attr('x2', view1_qubit_padding_left*theta)
        .attr('y1', view1_block_top)
        .attr('y2', view1_block_top + view1_qubitHeight*theta-10)


    /*画一串一串糖葫芦*/
    block.selectAll('circle')
        .data(d=>{return d['qubit']})
        .join('circle')
        // .each(d=>{console.log(d)})
        .attr('cx', view1_qubit_padding_left*theta)
        .attr('cy', (d,i)=>view1_block_top + i*2*view1_qubitMaxRadius*theta)
        .attr('r', d=>d['T1']*0.04*theta)
        .attr('fill', d=>d['T1']>=ref_value? '#90ce90':'#e18c8f')


    /*开始画每个 block 的坐标轴*/
    let arr = []
    let a = Object.values(data)
    for (let i in a){
        a[i].forEach(d=>{
            d['gate'].forEach(_d=>{
                arr.push(_d['error_rate'] * 100)
            })
        })
    }

    let extent = d3.extent(arr)/* 现在用所有computer的统一extent，以后考虑单独extent*/
    console.log(extent)

    let scale = d3.scaleLinear()
        .domain([0, extent[1]])
        .range([0, view1_computer_block_width - view1_qubit_padding_left])


    let bottom_axis = d3.axisTop()
        .scale(scale)
        .tickValues([0, extent[1]]);/*TODO: 格式化*/

    let bottom_axis_g = block.append('g')
        .attr('transform', `translate(${view1_qubit_padding_left},${view1_block_top + view1_computer_block_height})`)
        .call(bottom_axis)

    bottom_axis_g.selectAll('text')
        .attr('dy', "20px")
        .attr('dx', d=>d==0?'2px':"-7px")/*不容易*/



    /*开始画每个 computer 头顶的长的坐标轴*/
    time_arr = Object.values(data).map(d=>{return d.map(_d=>{return _d['timestamp']})})

    let timeline_g = qcomputer.append('g')
        .attr('transform', `translate(${view1_padding_left}, ${view1_padding_left})`)

    timeline_g.append('line')
        .style('stroke', '#747474')
        .style('stroke-width', 1)
        .attr('x1', 0)
        .attr('x2', d=>d.length*view1_computer_block_width)
        .attr('y1', 0)
        .attr('y2', 0)

    timeline_g.selectAll('text')
    .data(d=>{return d.map(_d=>_d['timestamp'])})
    .join('text')
    .text(d=>d)
    .attr('transform', (d,i)=>`translate(${i*view1_computer_block_width}, -4)`)
    .style('font-size', '0.7em')


    /*开始搞gate的连接的线*/
    block.selectAll('.gate')
    .data(d=>d['gate'])
    .join('line')
    .attr('class', 'gate')
    // .attr('transform', `translate(60, 0)`)
    .style('stroke', '#ababab')
    .style('stroke-width', 1.5)
    .attr('x1', d=>scale(d['error_rate']*100)+view1_qubit_padding_left)
    .attr('x2', d=>scale(d['error_rate']*100)+view1_qubit_padding_left)
    .attr('y1', d=>qubit_position_dict[d['source']])
    .attr('y2', d=>qubit_position_dict[d['target']])


    /*连接线的端点 - 起点*/
    block.selectAll('.source-dot')
    .data(d=>d['gate'])
    .join('circle')
    .attr('class', 'source-dot')
    .attr('cx', d=>scale(d['error_rate']*100)+view1_qubit_padding_left)
    .attr('cy', d=>qubit_position_dict[d['source']])
        .attr('r', 2)
    .attr('fill', '#ababab')


    /*连接线的端点 - 终点*/
    block.selectAll('.target-dot')
        .data(d=>d['gate'])
        .join('circle')
        .attr('class', 'target-dot')
        .attr('cx', d=>scale(d['error_rate']*100)+view1_qubit_padding_left)
        .attr('cy', d=>qubit_position_dict[d['target']])
        .attr('r', 2)
        .attr('fill', '#ababab')



    /*从这里开始画 填充折线图*/
    












</script>
<style>
text{
    font-family: Arial;
}
</style>
</html>